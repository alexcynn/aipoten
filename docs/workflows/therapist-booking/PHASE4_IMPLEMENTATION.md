# Phase 4: 예약 시스템 구현 완료

## 📅 구현 일자
2025-10-15

## ✅ 완료된 작업

### 1. 데이터 모델 구현

#### 새로운 Enum 추가
```prisma
enum SessionType {
  CONSULTATION  // 상담 (1회만 가능)
  THERAPY       // 치료 (1/4/8/12회 가능)
}

enum BookingStatus {
  PENDING_CONFIRMATION  // 결제 완료, 치료사 확인 대기
  CONFIRMED             // 치료사 확인 완료
  IN_PROGRESS           // 세션 진행 중
  COMPLETED             // 세션 완료
  CANCELLED             // 취소됨
  NO_SHOW               // 노쇼
  REJECTED              // 치료사가 거절
}
```

#### Booking 모델 생성
- 타임슬롯, 부모, 자녀, 치료사와의 관계 설정
- 예약 정보 (일정, 세션 타입, 세션 수 등)
- 확인 관리 (확인 마감시간, 확인/거절 정보)
- 취소 관리 (취소 사유, 환불 금액)
- 결제 정보 (원가, 할인율, 최종 금액)
- 방문 정보 및 메모

### 2. API 엔드포인트 구현

#### 부모용 API

**치료사 검색**
- `GET /api/therapists/search`
  - 전문 분야, 지역, 연령 범위, 상담료 범위로 필터링
  - 날짜 범위 지정 시 가용한 슬롯이 있는 치료사만 조회
  - 페이지네이션 지원
  - 승인된 치료사만 조회

**치료사 상세 조회**
- `GET /api/therapists/[id]`
  - 치료사 프로필, 자격증, 경력 정보 포함

**치료사 가용 슬롯 조회**
- `GET /api/therapists/[id]/available-slots`
  - 날짜 범위 내 예약 가능한 타임슬롯 조회
  - 날짜별로 그룹화된 데이터 제공

**예약 생성**
- `POST /api/bookings`
  - 타임슬롯, 자녀, 세션 타입, 세션 수 지정
  - 자동 요금 계산 (세션 수에 따른 할인 적용)
  - 치료사 확인 마감시간 자동 설정 (48시간)
  - 트랜잭션으로 타임슬롯 예약 카운트 업데이트

**예약 목록 조회**
- `GET /api/bookings`
  - 상태별, 자녀별 필터링 지원

**예약 상세 조회**
- `GET /api/bookings/[id]`
  - 권한 확인 (본인, 담당 치료사, 관리자만 조회 가능)

**예약 취소**
- `POST /api/bookings/[id]/cancel`
  - 취소 시점에 따른 자동 환불 금액 계산
    - 24시간 이전: 100% 환불
    - 12-24시간: 50% 환불
    - 12시간 이내: 환불 없음
  - 트랜잭션으로 타임슬롯 예약 카운트 업데이트

#### 치료사용 API

**예약 목록 조회**
- `GET /api/therapist/bookings`
  - 상태별, 날짜 범위별 필터링
  - 통계 정보 포함 (상태별 예약 수)

**예약 확인/거절**
- `POST /api/bookings/[id]/confirm`
  - 예약 확인 또는 거절 처리
  - 거절 시 타임슬롯 예약 카운트 복구

## 📊 주요 기능

### 1. 지능형 검색
- 다양한 필터 옵션 (전문 분야, 지역, 연령 범위, 상담료)
- 날짜 범위 지정 시 실제 가용 슬롯이 있는 치료사만 표시
- 가용 슬롯 수 정보 제공

### 2. 자동 요금 계산
- 세션 수에 따른 할인율 자동 적용
  - 4회: 10% 할인
  - 8회: 15% 할인
  - 12회: 20% 할인

### 3. 예약 확인 시스템
- 예약 생성 시 48시간 확인 마감시간 설정
- 치료사가 확인/거절 가능
- 거절 시 타임슬롯 자동 복구

### 4. 환불 정책
- 취소 시점에 따른 자동 환불 금액 계산
- 예약 정보에 환불 금액 기록

### 5. 트랜잭션 처리
- 예약 생성/취소/거절 시 타임슬롯 카운트와 동시 업데이트
- 데이터 일관성 보장

## 🔒 권한 관리

### 부모 (PARENT)
- 치료사 검색 및 상세 조회
- 본인 자녀에 대한 예약 생성
- 본인 예약 목록 조회
- 본인 예약 취소

### 치료사 (THERAPIST)
- 본인 예약 목록 조회
- 본인 예약 확인/거절

### 관리자 (ADMIN)
- 모든 예약 조회 및 관리

## 📁 생성된 파일

```
src/app/api/
├── therapists/
│   ├── search/
│   │   └── route.ts               # 치료사 검색 API
│   └── [id]/
│       ├── route.ts                # 치료사 상세 조회 API
│       └── available-slots/
│           └── route.ts            # 가용 슬롯 조회 API
├── bookings/
│   ├── route.ts                    # 예약 생성/목록 조회 API
│   └── [id]/
│       ├── route.ts                # 예약 상세 조회 API
│       ├── confirm/
│       │   └── route.ts            # 예약 확인/거절 API (치료사)
│       └── cancel/
│           └── route.ts            # 예약 취소 API (부모)
└── therapist/
    └── bookings/
        └── route.ts                # 치료사 예약 목록 조회 API

prisma/
└── schema.prisma                   # Booking 모델 및 Enum 추가
```

## 🚀 다음 단계 (Phase 4.2)

### 결제 연동
- [ ] 토스페이먼츠 또는 아임포트 연동
- [ ] 결제 승인 처리
- [ ] 결제 실패 처리
- [ ] 환불 API 연동

### 버퍼 타임 자동 차단
- [ ] 예약 확정 시 전후 버퍼 타임 자동 차단
- [ ] 버퍼 타임 설정 API (치료사)

### 알림 시스템
- [ ] 예약 생성 시 치료사에게 알림
- [ ] 예약 확인/거절 시 부모에게 알림
- [ ] 예약 취소 시 치료사에게 알림
- [ ] 예약 마감시간 임박 알림

### 관리자 기능
- [ ] 미확인 예약 관리 페이지
- [ ] 예약 통계 대시보드
- [ ] 환불 관리 시스템

## 📝 참고사항

### 환불 정책
현재 자동 계산되는 환불 정책:
- 24시간 이전 취소: 100% 환불
- 12-24시간 취소: 50% 환불
- 12시간 이내 취소: 환불 없음

실제 서비스 배포 시 정책 조정 필요

### 확인 마감시간
현재 예약 생성 후 48시간으로 설정
필요시 조정 가능

### 세션 횟수별 할인율
- 1회: 할인 없음
- 4회: 10% 할인
- 8회: 15% 할인
- 12회: 20% 할인

## 🔧 테스트 필요 항목

1. 예약 생성 플로우 전체 테스트
2. 동시 예약 시도 시 경쟁 조건 테스트
3. 취소/환불 정책 테스트
4. 권한 검증 테스트
5. 트랜잭션 롤백 테스트

## 💡 개선 제안

1. 예약 생성 시 실시간 재고 확인 (Optimistic Locking)
2. 예약 대기열 시스템 (인기 치료사용)
3. 정기 예약 시스템 (반복 예약)
4. 예약 변경 기능 (취소 후 재예약이 아닌 직접 변경)
5. 리뷰 시스템 연동 (예약 완료 후 리뷰 작성)
